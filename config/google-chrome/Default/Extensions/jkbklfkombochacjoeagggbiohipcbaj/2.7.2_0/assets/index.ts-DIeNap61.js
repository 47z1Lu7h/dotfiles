import{y as W,m,p as P,M as B,k as u,T as h,w as k,S as X}from"./index-DlCsJJXa.js";import{b as Y,y as Z,A as ee,I as te,h as se,g as ae,C as ne,m as re,u as ie,p as R,d as U,P as A,f as oe}from"./features-wsg242ee.js";import{p as I,d as ce,h as S,e as ue}from"./const-VfW2e5AY.js";function le(a){const{hostMatch:e,extensionId:t,extensionName:s}=a;chrome.tabs.onUpdated.addListener(async(n,r,i)=>{if(i&&i.url&&i&&i.url&&r&&r.status==="loading"){const p=new URL(i.url).hostname;if(e.find(l=>!!~l.indexOf(p))){const l=chrome.runtime.getManifest();chrome.scripting.executeScript({injectImmediately:!0,world:"MAIN",target:{tabId:n,allFrames:!0},func:f=>{window[f.slug]=f},args:[{id:chrome.runtime.id,slug:t,extensionName:s,version:l.version,icons:l.icons,extensionFolderUri:chrome.runtime.getURL("/"),isProdMode:"update_url"in chrome.runtime.getManifest()}]})}}})}var z=(a=>(a[a.FREE=0]="FREE",a[a.BASIC=1]="BASIC",a[a.PREMIUM=2]="PREMIUM",a))(z||{});const de={type:"object",properties:{uid:{type:"string",default:""},email:{type:"string",default:""},stripeId:{type:"string",default:""},name:{type:"string",default:""},payments:{type:"array",items:{type:"object",properties:{},required:[],default:{}},default:[]},plan:{type:"string",default:z.FREE},isSubscriptionActive:{type:"boolean",default:!1},lastCheckAt:{type:"number",default:0}},required:["uid","email","stripeId","name","payments","plan","isSubscriptionActive","lastCheckAt"],default:{}},me={type:"object",properties:{},required:[],default:{}},ge={type:"object",properties:{},required:[],default:{}},D={customerDataV2:de,features:me,persistLocalStorage:ge};function G(){return Math.floor(new Date().getTime()/1e3)}function O(a){return a+86400<G()}async function he(a){const e=await chrome.tabs.query({url:a.filter(t=>!~t.indexOf("esuit"))});for(let t of e)t.id&&await chrome.tabs.reload(t.id)}let T=[];const{updateBucket:_,getBucket:F,deleteBucket:$}=P(D);function pe(a){m("logout",async()=>{await $("customerDataV2"),await $("features")}),m("login",async()=>{const e=new URLSearchParams({[B.RETURN_EXT_LOCAL]:chrome.runtime.id}).toString();await chrome.tabs.create({url:`https://esuit.dev/login?${e}`,active:!0})}),m("closePopup",async()=>{chrome.extension.getViews({type:"popup"}).forEach(e=>{e.window.close()})}),m("openOptionsPage",async e=>{const t=chrome.runtime.getURL("src/pages/options/index.html"+(e?"#showSubscription=1":""));(await chrome.tabs.query({url:[t]})).forEach(s=>(s==null?void 0:s.id)&&chrome.tabs.remove(s.id)),await new Promise(s=>setTimeout(s,300)),await chrome.tabs.create({url:t,active:!0})}),m("getCustomerData",async()=>{const e=await F("customerDataV2");if(e.uid)return O(e.lastCheckAt)&&u("reFetchCustomerData"),e}),m("reFetchCustomerData",async(e=!1)=>{const t=await F("customerDataV2"),s=t.uid;if(!s)return!1;if(!e&&s&&!O(t.lastCheckAt))return!0;let n=null,r=null;try{const[l,f]=await Promise.all([fetch(`https://getusersubscription-57pphaecyq-uc.a.run.app/?token=${Y(s,a.projectId)}`).then(w=>w.json()),fe()]);if(l.stripeId&&(n=l),f){const w=f.find(c=>c.projectId===a.projectId);w&&(r=w)}}catch(l){return console.error(l),"Unknown error, please contact the developer."}if(!n||!r)return"ERROR: reFetchCustomerData returned undefined";let i=n.allPayments.filter(l=>ee(l.status)||te(l.status)||se(l.status)||ae(l.status)||ne(l.status)),p=h.FREE;return q(i,r,h.BASIC)&&(p=h.BASIC),q(i,r,h.PREMIUM)&&(p=h.PREMIUM),await _("customerDataV2",async l=>n?{uid:s,stripeId:n.stripeId,email:n.email,name:n.name,payments:n.allPayments,plan:p,isSubscriptionActive:p!==h.FREE,lastCheckAt:G()}:l),u("rejectFeaturesToWindow"),!0}),m("visitPricingPage",async()=>{const e=`https://esuit.dev/pricing/${a.projectId}`,t=new URLSearchParams({[B.RETURN_EXT_LOCAL]:chrome.runtime.id}).toString();await chrome.tabs.create({url:e+`?${t}`,active:!0})}),m("visitDashboard",async()=>{await chrome.tabs.create({url:"https://esuit.dev/dashboard",active:!0}),u("closePopup")}),k("ifUserLogin",async()=>!!(await F("customerDataV2")).uid),k("userInfoUpdate",async([e])=>{e&&(await _("customerDataV2",t=>(t.uid=e,t)),await u("reFetchCustomerData",!0),u("openOptionsPage",!0),setTimeout(()=>{he(a.hostMatch)},2e3))})}async function fe(){if(T.length>0)return T;const a=await fetch("https://static-data.esuit.dev/index.json").then(e=>e.json());return T=Z(a),T}function q(a,e,t){return!!a.find(s=>{if(![...re,...ie,...R,...U,...A].includes(s.status)||[...R].includes(s.status)&&(!s.nextBillingDate||s.nextBillingDate<Math.ceil(new Date().getTime()/1e3))||[...U].includes(s.status)&&(!s.nextBillingDate||s.nextBillingDate<Math.ceil(new Date().getTime()/1e3))||[...A].includes(s.status)&&(!s.nextBillingDate||s.nextBillingDate<Math.ceil(new Date().getTime()/1e3)))return!1;const n=e.prices.find(r=>r.id===s.priceId);return!(!n||n.plan!==t)})}var ye=Object.defineProperty,be=(a,e,t)=>e in a?ye(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,M=(a,e,t)=>(be(a,typeof e!="symbol"?e+"":e,t),t);class j{constructor(e,t){M(this,"listeners",{}),M(this,"tabs",[]),M(this,"slug"),M(this,"isDebugger"),this.slug=e,this.isDebugger=!!t,this.bindMessage(),this.bindEvent()}on(e,t){if(this.listeners[e])throw new Error(`event listener ${String(e)} already exist!`);return this.listeners[e]=t,()=>{delete this.listeners[e]}}async send(e,...t){this.isDebugger&&console.log("send message from background script",{action:e,payload:t,tabs:this.tabs});for(let s of this.tabs)try{const n=await chrome.tabs.get(s);n&&n.id?chrome.tabs.sendMessage(n.id,{from:this.slug,payload:{action:e,payload:t}}):this.deleteTabById(s)}catch(n){console.log(n),this.deleteTabById(s)}}bindMessage(){chrome.runtime.onMessageExternal.addListener((e,t,s)=>{var n,r;if((n=t==null?void 0:t.tab)!=null&&n.id){if(this.isDebugger&&console.log("received message from page",{request:e,sender:t}),e.action==="__connect")return this.tabs.includes(t.tab.id)||this.tabs.push(t.tab.id),s();if(e.action==="__disconnect")return this.deleteTabById(t.tab.id),s();if(this.listeners[e.action])return(r=t==null?void 0:t.tab)!=null&&r.id?(this.tabs.includes(t.tab.id)||this.tabs.push(t.tab.id),this.listeners[e.action](...e.payload).then(i=>{this.isDebugger&&console.log("send to callback from background",{request:e,sender:t,res:i}),s(i)}),!0):s();console.log(`unknown event ${e.action}`)}})}bindEvent(){chrome.tabs.onRemoved.addListener(e=>{this.deleteTabById(e)})}deleteTabById(e){if(this.tabs.includes(e)){const t=this.tabs.indexOf(e);this.tabs.splice(t,1)}}}function we(a){return[h.FREE,h.BASIC,h.PREMIUM].indexOf(a)}function ve(a,e){const t=we(e);return a.limitation?a.limitation[t]:0}function N(a,e){return{[h.FREE]:1,[h.BASIC]:10,[h.PREMIUM]:100}[e]>=a.permission}function L(a,e){return a.map(t=>{e[t.key]?(e[t.key].enable=e[t.key].enable??t.defaultEnable,e[t.key].currentFreeTryCount=e[t.key].currentFreeTryCount??0):e[t.key]={enable:t.defaultEnable,currentFreeTryCount:0}}),e}function Ie(a){const{cacheId:e,defaultMemoConfig:t}=a;m("setUIMemoSettings",async s=>{await chrome.storage.local.set({[e]:s})}),m("getUIMemoSettings",async()=>{const s=await u("getFeaturesDataByPlan");let n=await new Promise(r=>{chrome.storage.local.get([e]).then(i=>{i[e]?r(i[e]):r(!1)})});return n||(n={...t}),Object.keys(n).map(r=>{const i=Object.values(s).find(l=>l._.memoKey===r);if(i&&i.needUpgrade&&(!i.enable||!(i.freeTryLeft>0||i.limitation>0)&&t[r]!==void 0))return p();function p(){n[r]=t[r]}}),{...t,...n}})}let Q=!1;function Se(){return Q}function Te(){Q=!0}const{updateBucket:E,getBucket:V}=P(D);function Me(a){if(Se())return;Te();const e=new j(a,!0);return m("getAllPersistLocalStorage",()=>V("persistLocalStorage")),m("setPersistLocalStorage",async(t,s)=>{await E("persistLocalStorage",n=>{try{s=JSON.stringify(s)}catch{}return n[t]=s,n})}),m("getPersistLocalStorage",async(t,s)=>{const n=await V("persistLocalStorage");if(n[t]){try{return JSON.parse(n[t])}catch{}return n[t]}return s??void 0}),m("clearPersistLocalStorage",async()=>{E("persistLocalStorage",()=>({}))}),m("removePersistLocalStorage",async t=>{E("persistLocalStorage",s=>(delete s[t],s))}),e.on("getAllPersistLocalStorage",()=>u("getAllPersistLocalStorage")),e.on("setPersistLocalStorage",(...t)=>u("setPersistLocalStorage",...t)),e.on("getPersistLocalStorage",(...t)=>u("getPersistLocalStorage",...t)),e.on("clearPersistLocalStorage",()=>u("clearPersistLocalStorage")),void e.on("removePersistLocalStorage",t=>u("removePersistLocalStorage",t))}const{setBucket:K,getBucket:x}=P(D);function Ce(a){const{projectId:e,hostMatch:t,cacheId:s,features:n,defaultMemoConfig:r}=a,i=new j(e,!0);return Me(a.projectId),Ie({cacheId:s,defaultMemoConfig:r}),chrome.tabs.onUpdated.addListener(async(c,d,o)=>{if(o&&o.url&&d.status==="loading"){const g=new URL(o.url).hostname;t.find(b=>!!~b.indexOf(g))&&l(c)}}),chrome.storage.onChanged.addListener((c,d)=>{d==="local"&&c&&c.features&&p()}),m("rejectFeaturesToWindow",async()=>{p()}),m("getFeature",async c=>f()[c]),m("consumeFeaturesTreeTryByMemoUIConfigs",async c=>{const d=await f();let o=[];Object.entries(c).map(([g,b])=>{if(r[g]!==void 0&&r[g]!==b){const y=Object.values(d).find(v=>v._.memoKey===g);y&&y.isCanFreeTry&&o.push(y._.key)}}),o.length>0&&u("consumeFeatureTreeTry",o)}),m("consumeFeatureTreeTry",async c=>{let d=L(n,await x("features"));const o=await w();let g=!1;c.map(b=>{const y=n.find(v=>v.key===b||v.memoKey===b);y&&(N(y,o)||(d[y.key].currentFreeTryCount++,g=!0))}),g&&await K("features",d)}),m("saveFeaturesEnables",async c=>{let d=L(n,await x("features"));Object.entries(c).map(([o,g])=>{d[o].enable=g}),await K("features",d)}),m("getFeaturesDataByPlan",f),i.on("getUIMemoSettings",()=>u("getUIMemoSettings")),i.on("setUIMemoSettings",c=>u("setUIMemoSettings",c)),i.on("consumeFeatureTreeTry",c=>u("consumeFeatureTreeTry",c)),i.on("visitPricingPage",()=>u("visitPricingPage")),void i.on("consumeFeaturesTreeTryByMemoUIConfigs",c=>{u("consumeFeaturesTreeTryByMemoUIConfigs",c)});async function p(){const c=await chrome.tabs.query({url:t});c&&c.map(d=>{d&&d.id&&l(d.id)})}async function l(c){const d=await f();chrome.scripting.executeScript({injectImmediately:!0,world:"MAIN",target:{tabId:c,allFrames:!0},func:(o,g)=>{window[g]=JSON.parse(o)},args:[JSON.stringify(d),`${e.replaceAll("-","_")}`]})}async function f(){const c=await w();let d=L(n,await x("features"));return n.map(o=>{var g;const b=N(o,c);let y,v=0;return o.memoKey&&(y=r[o.memoKey]),o.maxFreeTryCount&&d[o.key].currentFreeTryCount!==void 0&&(v=Math.max(0,o.maxFreeTryCount-d[o.key].currentFreeTryCount)),{enable:((g=d[o.key])==null?void 0:g.enable)??o.defaultEnable,needUpgrade:!b,limitation:ve(o,c),permission:o.permission,freeTryLeft:o.maxFreeTryCount?v:0,isCanFreeTry:!!o.maxFreeTryCount&&o.maxFreeTryCount>0,defaultValue:y,_:o}}).reduce((o,g)=>(o[g._.key]=g,o),{})}async function w(){const c=await u("getCustomerData");return c?c.plan:h.FREE}}function Pe(a,e){(async()=>{let t=0,s=(await chrome.declarativeNetRequest.getDynamicRules()).map(r=>r.id);const n=a.map((r,i)=>(t=i+1,{id:t,priority:1,action:{type:"modifyHeaders",responseHeaders:[{header:"Content-Security-Policy",operation:"remove"},{header:"Content-Security-Policy-Report-Only",operation:"remove"}]},condition:{regexFilter:r,resourceTypes:["main_frame","xmlhttprequest"]}}));await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:s,addRules:n})})()}function De(a){const e=new j(a,!0);e.on("reFetchCustomerData",t=>u("reFetchCustomerData",t)),e.on("visitDashboard",()=>u("visitDashboard")),e.on("getCustomerData",()=>u("getCustomerData")),e.on("logout",()=>u("logout")),e.on("login",()=>u("login"))}function Fe(a){W(D),pe(a),De(a.projectId)}var Le=Object.defineProperty,Ee=(a,e,t)=>e in a?Le(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,C=(a,e,t)=>(Ee(a,typeof e!="symbol"?e+"":e,t),t);class xe{constructor(e,t){C(this,"listeners",{}),C(this,"tabs",[]),C(this,"slug"),C(this,"isDebugger"),this.slug=e,this.isDebugger=!!t,this.bindMessage(),this.bindEvent()}on(e,t){if(this.listeners[e])throw new Error(`event listener ${String(e)} already exist!`);return this.listeners[e]=t,()=>{delete this.listeners[e]}}async send(e,...t){this.isDebugger&&console.log("send message from background script",{action:e,payload:t,tabs:this.tabs});for(let s of this.tabs)try{const n=await chrome.tabs.get(s);n&&n.id?chrome.tabs.sendMessage(n.id,{from:this.slug,payload:{action:e,payload:t}}):this.deleteTabById(s)}catch(n){console.log(n),this.deleteTabById(s)}}bindMessage(){chrome.runtime.onMessageExternal.addListener((e,t,s)=>{var n,r;if((n=t==null?void 0:t.tab)!=null&&n.id){if(this.isDebugger&&console.log("received message from page",{request:e,sender:t}),e.action==="__connect")return this.tabs.includes(t.tab.id)||this.tabs.push(t.tab.id),s();if(e.action==="__disconnect")return this.deleteTabById(t.tab.id),s();if(this.listeners[e.action])return(r=t==null?void 0:t.tab)!=null&&r.id?(this.tabs.includes(t.tab.id)||this.tabs.push(t.tab.id),this.listeners[e.action](...e.payload).then(i=>{this.isDebugger&&console.log("send to callback from background",{request:e,sender:t,res:i}),s(i)}),!0):s();console.log(`unknown event ${e.action}`)}})}bindEvent(){chrome.tabs.onRemoved.addListener(e=>{this.deleteTabById(e)})}deleteTabById(e){if(this.tabs.includes(e)){const t=this.tabs.indexOf(e);this.tabs.splice(t,1)}}}const J=new xe(I,!0),{updateBucket:H,getBucket:je}=P(X);function Be(){J.on("updateCounts",async a=>{H("global",e=>{let t={...ce,...e.counts};const{reels:s,suggested:n,sponsored:r}=a;return t.reels+=s,t.suggested+=n,t.sponsored+=r,e.counts=t,e})}),J.on("showPromotionPage",async()=>{const{haveShared:a,counts:e,lastTimeShowedPromotionPage:t}=await je("global");if(a)return;const s=Math.floor(new Date().getTime()/1e3);t+60*60*24*7>=s||Object.values(e).reduce((r,i)=>(r+=i||0,r),0)<1e3||(chrome.runtime.openOptionsPage(),H("global",r=>(r.lastTimeShowedPromotionPage=s,r)))})}Pe(S);Be();le({hostMatch:S,extensionId:I,extensionName:ue});Fe({projectId:I,hostMatch:S});Ce({projectId:I,hostMatch:S,cacheId:"app-2.2.0",features:oe,defaultMemoConfig:{}});W(X);chrome.scripting.registerContentScripts([{id:`inject-${I}`,js:["injects/proxy.js"],matches:S,runAt:"document_start",world:"MAIN"}]);chrome.scripting.registerContentScripts([{id:`inject-${I}-module`,js:["injects/vendors.js","injects/index.js"],matches:S,runAt:"document_end",world:"MAIN"}]);
